<!DOCTYPE html>
<html lang="en">
<head>
  {% include './head.html' %}
</head>
<body>
  {% include './header.html' %}

  <main>

    <sl-card>
      <h1 slot="header">
        <sl-icon slot="icon" name="bar-chart"></sl-icon>
        Analyzer Benchmarks
      </h1>

      <figure class="benchmarks-bar-chart" role="group" aria-labelledby="bar-caption">
        <figcaption id="bar-caption" style="font-weight:bold;margin-bottom:0.5em;">
          Benchmark results: lower is better (seconds)
        </figcaption>
        <bar-chart id="perf-bar-chart">
          <svg width="100%" height="{{ results.results|length * 44 + 40 }}">
            {% set max_value = results.results | map('averageTime') | max %}
            {% for i, result in results.results | enumerate %}
            {% set bar_length = 480 * result.averageTime / max_value %}
            <rect x="120"
                  y="{{ i * 44 + 12 }}"
                  height="32"
                  rx="4"
                  width="{{ bar_length }}"
                  fill="{{ result.color or '#4e79a7' }}">
            <title>{{ result.tool }}: {{ result.averageTime }}</title>
            </rect>
            <text x="8" y="{{ i * 44 + 32 }}" font-size="16" fill="currentColor">{{ result.name }}</text>
            <text x="{{ 130 + bar_length }}" y="{{ i * 44 + 32 }}" font-size="16" fill="currentColor">{{ result.averageTime }}</text>
            {% endfor %}
          </svg>
        </bar-chart>
      </figure>

      <div slot=footer><strong>Number of runs per tool:</strong> {{ results.runs }}</div>
      <div slot=footer><strong slot=footer>Number of files analyzed per run:</strong> {{ results.file_count }}</div>
    </sl-card>
    <div class="tool-cards">
      {% for result in results.results %}
      <sl-card class="analyzer-tool-card" style="margin-top:2rem;">
        <div slot="header" class="analyzer-tool-header">
          <sl-icon name="box-seam"></sl-icon>
          <span class="analyzer-tool-title">{{ result.name }}</span>
          <sl-badge variant="primary" pill class="analyzer-tool-badge">{{ result.id }}</sl-badge>
        </div>
        <div class="analyzer-tool-docslink">
          <sl-tag size="small" pill>
            <sl-icon slot="prefix" name="code"></sl-icon>
            <a href="{{ result.docsUrl }}" target="_blank">
              Docs
              <sl-icon slot="suffix" name="box-arrow-up-right"></sl-icon>
            </a>
          </sl-tag>
        </div>
        <div class="analyzer-tool-stats" style="display:flex;gap:2em;margin:1em 0;">
          <div>
            <sl-badge variant="success" pill>
              <sl-icon slot="prefix" name="clock"></sl-icon>
              {{ result.averageTime }}s
            </sl-badge>
            <div class="analyzer-tool-label">Avg Time</div>
          </div>
          <div>
            <sl-badge variant="neutral" pill>
              <sl-icon slot="prefix" name="file-text"></sl-icon>
              {{ result.averageSize }}KB
            </sl-badge>
            <div class="analyzer-tool-label">Avg Output Size</div>
          </div>
          <div>
            <sl-badge variant="warning" pill>
              <sl-icon slot="prefix" name="hash"></sl-icon>
              {{ result.runs | length }}
            </sl-badge>
            <div class="analyzer-tool-label">Runs</div>
          </div>
        </div>
        <sl-input readonly value="{{ result.command }}" label="Command"></sl-input>
        <sl-details summary="Run Breakdown">
          <ul class="analyzer-tool-runs">
            {% for run in result.runs %}
              {% if run.time is not none %}
                <li>
                  <sl-badge variant="success" pill>
                    Run {{ run.run }}
                  </sl-badge>
                  <sl-badge variant="primary" pill>
                    <sl-icon slot="prefix" name="clock"></sl-icon>
                    {{ run.time }}s
                  </sl-badge>
                  <sl-badge variant="neutral" pill>
                    <sl-icon slot="prefix" name="file-text"></sl-icon>
                    {{ run.size }}KB
                  </sl-badge>
                </li>
              {% else %}
                <li>
                  <sl-badge variant="danger" pill>
                    Run {{ run.run }} FAILED
                  </sl-badge>
                  {% if run.error %}
                    <sl-details summary="Show Error"><pre>{{ run.error }}</pre></sl-details>
                  {% endif %}
                </li>
              {% endif %}
            {% endfor %}
          </ul>
        </sl-details>
        <sl-details summary="Last Output (JSON)">
          <sl-spinner style="font-size: 3rem;"></sl-spinner>
          <zero-md id="last-output-{{ loop.index0 }}" no-auto>
            <template>
              <link id="prism-light" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets@11/styles/github.min.css" disabled>
              <link id="prism-dark" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets@11/styles/github-dark.min.css" disabled>
            </template>
            <script type="text/markdown">
```json
{{ result.lastOutput | dump(2) | safe }}
```
            </script>
          </zero-md>
        </sl-details>
        {% if result.lastError and result.lastError.trim() %}
        <sl-alert variant="danger" open>
          <sl-icon slot="icon" name="exclamation-triangle"></sl-icon>
          Last error: <pre>{{ result.lastError }}</pre>
        </sl-alert>
        {% endif %}
      </sl-card>
      {% endfor %}
    </div>
  </main>

  <script type="module">
    import "{{rootUrl}}/bar-chart.js";
    import ZeroMd from "https://esm.sh/zero-md@3";
    customElements.define('zero-md', ZeroMd);
  </script>
  {% include './footer.html' %}
</body>
</html>
