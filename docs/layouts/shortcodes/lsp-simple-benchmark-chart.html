{{ $combined := index .Site.Data "lsp-benchmark-results" | default dict }}
{{ $cem := index $combined.servers "cem" | default dict }}
{{ $wc := index $combined.servers "wc-toolkit" | default dict }}

{{ if and $cem.benchmarks $wc.benchmarks }}
{{/* Only show simple protocol operations */}}
{{ $simpleBenchmarks := slice "startup" "hover" "completion" "diagnostics" "references_performance" }}
{{ $bar_height := 40 }}
{{ $bar_spacing := 60 }}
{{ $max_value_label_width := 70 }}
{{ $chart_width := 530 }}
{{ $label_width := 220 }}
{{ $total_width := add (add $chart_width $label_width) $max_value_label_width }}

{{/* Human-readable labels */}}
{{ $benchmarkLabels := dict
  "startup" "Server Startup"
  "hover" "Hover Info"
  "completion" "Autocompletion"
  "diagnostics" "Diagnostics"
  "references_performance" "Find References"
}}

<div class="lsp-simple-benchmark-chart">
  <svg viewBox="0 0 {{ $total_width }} {{ add (mul (len $simpleBenchmarks) $bar_spacing) 40 }}" style="width: 100%; height: auto;">
    <defs>
      <linearGradient id="cem-gradient-simple" x1="0%" y1="0%" x2="100%" y2="0%">
        <stop offset="0%" style="stop-color:var(--cem-start);stop-opacity:1" />
        <stop offset="100%" style="stop-color:var(--cem-end);stop-opacity:1" />
      </linearGradient>
      <linearGradient id="wc-gradient-simple" x1="0%" y1="0%" x2="100%" y2="0%">
        <stop offset="0%" style="stop-color:var(--wc-start);stop-opacity:1" />
        <stop offset="100%" style="stop-color:var(--wc-end);stop-opacity:1" />
      </linearGradient>
    </defs>

    {{ $y := 20 }}
    {{ range $i, $benchmarkName := $simpleBenchmarks }}
      {{ $cemBench := index $cem.benchmarks $benchmarkName }}
      {{ $wcBench := index $wc.benchmarks $benchmarkName }}

      {{ if and $cemBench $wcBench }}
        {{ $cemTime := 0.0 }}
        {{ $wcTime := 0.0 }}

        {{/* Extract time from various data structures */}}
        {{ if $cemBench.statistics }}
          {{ $cemTime = $cemBench.statistics.mean }}
        {{ else if $cemBench.overall_statistics }}
          {{ $cemTime = $cemBench.overall_statistics.mean }}
        {{ else if $cemBench.average_duration_ms }}
          {{ $cemTime = $cemBench.average_duration_ms }}
        {{ else if $cemBench.duration_ms }}
          {{ $cemTime = $cemBench.duration_ms }}
        {{ else if $cemBench.average_search_time }}
          {{ $cemTime = $cemBench.average_search_time }}
        {{ end }}

        {{ if $wcBench.statistics }}
          {{ $wcTime = $wcBench.statistics.mean }}
        {{ else if $wcBench.overall_statistics }}
          {{ $wcTime = $wcBench.overall_statistics.mean }}
        {{ else if $wcBench.average_duration_ms }}
          {{ $wcTime = $wcBench.average_duration_ms }}
        {{ else if $wcBench.duration_ms }}
          {{ $wcTime = $wcBench.duration_ms }}
        {{ else if $wcBench.average_search_time }}
          {{ $wcTime = $wcBench.average_search_time }}
        {{ end }}

        {{ $maxTime := cond (gt $cemTime $wcTime) $cemTime $wcTime }}

        {{ if gt $maxTime 0 }}
        {{ $cemWidth := div (mul $chart_width $cemTime) $maxTime }}
        {{ $wcWidth := div (mul $chart_width $wcTime) $maxTime }}

        {{ $cemText := printf "%.2fms" $cemTime }}
        {{ $wcText := printf "%.2fms" $wcTime }}

        {{ $displayLabel := index $benchmarkLabels $benchmarkName }}

        <!-- Benchmark label -->
        <text x="0" y="{{ add $y 12 }}"
              font-size="14"
              font-weight="600"
              fill="var(--label-color)">
          {{ $displayLabel }}
        </text>

        {{/* Add correctness annotation */}}
        {{ $cemCorrectness := "" }}
        {{ $wcCorrectness := "" }}

        {{ if eq $benchmarkName "hover" }}
          {{ if $cemBench.hover_results }}
            {{ $totalContent := 0.0 }}
            {{ $count := 0 }}
            {{ range $cemBench.hover_results }}
              {{ if .avg_content_length }}
                {{ $totalContent = add $totalContent .avg_content_length }}
                {{ $count = add $count 1 }}
              {{ end }}
            {{ end }}
            {{ if gt $count 0 }}{{ $cemCorrectness = printf "%.0f chars" (div $totalContent (float $count)) }}{{ end }}
          {{ end }}
          {{ if $wcBench.hover_results }}
            {{ $totalContent := 0.0 }}
            {{ $count := 0 }}
            {{ range $wcBench.hover_results }}
              {{ if .avg_content_length }}
                {{ $totalContent = add $totalContent .avg_content_length }}
                {{ $count = add $count 1 }}
              {{ end }}
            {{ end }}
            {{ if gt $count 0 }}{{ $wcCorrectness = printf "%.0f chars" (div $totalContent (float $count)) }}{{ end }}
          {{ end }}
        {{ else if eq $benchmarkName "completion" }}
          {{ if $cemBench.completion_results }}
            {{ $totalItems := 0.0 }}
            {{ $count := 0 }}
            {{ range $cemBench.completion_results }}
              {{ if .avg_item_count }}
                {{ $totalItems = add $totalItems .avg_item_count }}
                {{ $count = add $count 1 }}
              {{ end }}
            {{ end }}
            {{ if gt $count 0 }}{{ $cemCorrectness = printf "%.1f items" (div $totalItems (float $count)) }}{{ end }}
          {{ end }}
          {{ if $wcBench.completion_results }}
            {{ $totalItems := 0.0 }}
            {{ $count := 0 }}
            {{ range $wcBench.completion_results }}
              {{ if .avg_item_count }}
                {{ $totalItems = add $totalItems .avg_item_count }}
                {{ $count = add $count 1 }}
              {{ end }}
            {{ end }}
            {{ if gt $count 0 }}{{ $wcCorrectness = printf "%.1f items" (div $totalItems (float $count)) }}{{ end }}
          {{ end }}
        {{ end }}

        {{ if $cemCorrectness }}
        <!-- CEM correctness annotation -->
        <text x="{{ add $label_width $cemWidth 4 }}"
              y="{{ add $y 12 }}"
              font-size="10"
              fill="var(--correctness-color)">
          ({{ $cemCorrectness }})
        </text>
        {{ end }}

        {{ if $wcCorrectness }}
        <!-- wc-toolkit correctness annotation -->
        <text x="{{ add $label_width $wcWidth 4 }}"
              y="{{ add $y 34 }}"
              font-size="10"
              fill="var(--correctness-color)">
          ({{ $wcCorrectness }})
        </text>
        {{ end }}

        <!-- CEM bar -->
        <rect x="{{ $label_width }}"
              y="{{ $y }}"
              width="{{ $cemWidth }}"
              height="16"
              rx="3"
              fill="url(#cem-gradient-simple)">
          <title>CEM: {{ $cemText }}</title>
        </rect>
        <text x="{{ add $label_width $chart_width 8 }}"
              y="{{ add $y 12 }}"
              font-size="12"
              fill="var(--value-color)">
          {{ $cemText }}
        </text>

        <!-- wc-toolkit bar -->
        <rect x="{{ $label_width }}"
              y="{{ add $y 22 }}"
              width="{{ $wcWidth }}"
              height="16"
              rx="3"
              fill="url(#wc-gradient-simple)">
          <title>wc-toolkit: {{ $wcText }}</title>
        </rect>
        <text x="{{ add $label_width $chart_width 8 }}"
              y="{{ add $y 34 }}"
              font-size="12"
              fill="var(--value-color)">
          {{ $wcText }}
        </text>

        {{ $y = add $y $bar_spacing }}
        {{ end }}
      {{ end }}
    {{ end }}

    <!-- Legend -->
    {{ $legendY := sub $y 10 }}
    <rect x="{{ $label_width }}" y="{{ $legendY }}" width="80" height="14" rx="3" fill="url(#cem-gradient-simple)" />
    <text x="{{ add $label_width 88 }}" y="{{ add $legendY 11 }}" font-size="12" fill="var(--label-color)">CEM LSP</text>

    <rect x="{{ add $label_width 180 }}" y="{{ $legendY }}" width="80" height="14" rx="3" fill="url(#wc-gradient-simple)" />
    <text x="{{ add $label_width 268 }}" y="{{ add $legendY 11 }}" font-size="12" fill="var(--label-color)">wc-toolkit</text>
  </svg>
</div>

<style>
.lsp-simple-benchmark-chart {
  margin: 2em 0;
  padding: 1em;
  background: var(--sl-color-bg-nav);
  border-radius: 0.5rem;

  --cem-start: light-dark(#3b82f6, #60a5fa);
  --cem-end: light-dark(#60a5fa, #93c5fd);
  --wc-start: light-dark(#8b5cf6, #a78bfa);
  --wc-end: light-dark(#a78bfa, #c4b5fd);

  --label-color: light-dark(#1f2937, #f3f4f6);
  --value-color: light-dark(#6b7280, #d1d5db);
  --correctness-color: light-dark(#10b981, #34d399);
}

.lsp-simple-benchmark-chart svg {
  background: transparent;
}
</style>
{{ else }}
<p><em>Run <code>make bench-lsp</code> to generate comparison charts.</em></p>
{{ end }}
