name: Health Report (Dispatch)

on:
  workflow_dispatch:
    inputs:
      package-path:
        description: "Path to the package"
        type: string
        default: "."
      cem-version:
        description: "cem version to install (semver, without v prefix). If empty, reads from package.json or uses latest."
        type: string
        default: ""
      fail-below:
        description: "Exit 1 if overall percentage is below this threshold (0-100)"
        type: number
        default: 0
      generate-args:
        description: "Additional arguments for cem generate"
        type: string
        default: ""
      health-args:
        description: "Additional arguments for cem health"
        type: string
        default: ""

jobs:
  health:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup cem
        uses: ./.github/actions/setup-cem
        with:
          package-path: ${{ inputs.package-path || '.' }}
          cem-version: ${{ inputs.cem-version }}
          generate-args: ${{ inputs.generate-args }}
          github-token: ${{ github.token }}

      - name: Generate health report
        env:
          PKG_PATH: ${{ inputs.package-path || '.' }}
          HEALTH_ARGS: ${{ inputs.health-args }}
        run: |
          # shellcheck disable=SC2086
          cem health -p "$PKG_PATH" --format markdown $HEALTH_ARGS > health_report.md

      - name: Log health report
        run: cat health_report.md

      - name: Post job summary
        run: cat health_report.md >> "$GITHUB_STEP_SUMMARY"

      - name: Check fail-below threshold
        if: (inputs.fail-below || 0) > 0
        env:
          PKG_PATH: ${{ inputs.package-path || '.' }}
          FAIL_BELOW: ${{ inputs.fail-below }}
          HEALTH_ARGS: ${{ inputs.health-args }}
        run: |
          # shellcheck disable=SC2086
          cem health -p "$PKG_PATH" \
            --fail-below "$FAIL_BELOW" \
            --format text $HEALTH_ARGS > /dev/null
