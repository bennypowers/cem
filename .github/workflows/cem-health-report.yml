name: Health Report

on:
  workflow_call:
    inputs:
      package-path:
        description: "Path to the package"
        type: string
        default: "."
      cem-version:
        description: "cem version to install (semver, without v prefix). If empty, reads from package.json or uses latest."
        type: string
        default: ""
      fail-below:
        description: "Exit 1 if overall percentage is below this threshold (0-100)"
        type: number
        default: 0
      generate-args:
        description: "Additional arguments for cem generate"
        type: string
        default: ""
      health-args:
        description: "Additional arguments for cem health"
        type: string
        default: ""

jobs:
  health:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup cem
        uses: bennypowers/cem/.github/actions/setup-cem@main
        with:
          package-path: ${{ inputs.package-path || '.' }}
          cem-version: ${{ inputs.cem-version }}
          generate-args: ${{ inputs.generate-args }}
          github-token: ${{ github.token }}

      - name: Generate health report
        uses: bennypowers/cem/.github/actions/pr-health-report@main
        with:
          package-path: ${{ inputs.package-path || '.' }}
          health-args: ${{ inputs.health-args }}

      - name: Log health report
        run: cat health_report.md

      - name: Find previous health comment
        id: find-comment
        uses: peter-evans/find-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: "github-actions[bot]"
          body-includes: "### Documentation Health"

      - name: Post or update health comment
        uses: peter-evans/create-or-update-comment@v5
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body-file: health_report.md
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          edit-mode: replace

      - name: Check fail-below threshold
        if: (inputs.fail-below || 0) > 0
        env:
          PKG_PATH: ${{ inputs.package-path || '.' }}
          FAIL_BELOW: ${{ inputs.fail-below }}
          HEALTH_ARGS: ${{ inputs.health-args }}
        run: |
          if [ ! -f changed_files.txt ]; then
            echo "No relevant changed files, skipping threshold check"
            exit 0
          fi
          mapfile -t files < changed_files.txt
          # shellcheck disable=SC2086
          cem health -p "$PKG_PATH" \
            --fail-below "$FAIL_BELOW" \
            --format text $HEALTH_ARGS "${files[@]}" > /dev/null
