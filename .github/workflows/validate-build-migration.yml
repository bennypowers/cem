name: Validate Build Migration

# This workflow compares outputs from the existing GoReleaser-based build
# against bennypowers/go-release-workflows to ensure binary compatibility
# before switching workflows.

on:
  workflow_dispatch:
  pull_request:
    paths:
      - 'Makefile'
      - 'Containerfile'
      - '.github/workflows/validate-build-migration.yml'
      - 'scripts/ldflags.sh'

jobs:
  # ==========================================================================
  # EXISTING BUILD (GoReleaser-based)
  # ==========================================================================
  build-existing:
    name: Existing Build (${{ matrix.node_platform }}-${{ matrix.node_arch }})
    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
            cc: gcc
            node_platform: linux
            node_arch: x64
            runner: ubuntu-latest
          - goos: linux
            goarch: arm64
            cc: aarch64-linux-gnu-gcc
            node_platform: linux
            node_arch: arm64
            runner: ubuntu-latest
          - goos: windows
            goarch: amd64
            cc: x86_64-w64-mingw32-gcc
            node_platform: win32
            node_arch: x64
            runner: ubuntu-latest
          - goos: windows
            goarch: arm64
            cc: aarch64-w64-mingw32-gcc
            node_platform: win32
            node_arch: arm64
            runner: ubuntu-latest
          - goos: darwin
            goarch: amd64
            cc: clang
            node_platform: darwin
            node_arch: x64
            runner: macos-latest
          - goos: darwin
            goarch: arm64
            cc: clang
            node_platform: darwin
            node_arch: arm64
            runner: macos-latest
      fail-fast: false
    runs-on: ${{ matrix.runner }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
        env:
          GOTOOLCHAIN: auto
          GOEXPERIMENT: jsonv2

      - name: Install cross-compilers for CGO (Linux only)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu gcc-mingw-w64 mingw-w64

      - name: Generate code
        run: make generate

      - name: Build with special toolchain for windows/arm64
        if: matrix.goos == 'windows' && matrix.goarch == 'arm64'
        run: |
          make windows-arm64
          mkdir -p existing-binaries
          # Normalize to go-release-workflows naming
          cp dist/cem-windows-arm64.exe existing-binaries/cem-win32-arm64.exe
        env:
          CGO_CFLAGS: -Wno-dll-attribute-on-redeclaration

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        if: ${{ !(matrix.goos == 'windows' && matrix.goarch == 'arm64') }}
        with:
          version: "~> v2"
          args: build --single-target --snapshot
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CGO_ENABLED: 1
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CC: ${{ matrix.cc }}
          GOEXPERIMENT: jsonv2

      - name: Normalize existing binary names
        if: ${{ !(matrix.goos == 'windows' && matrix.goarch == 'arm64') }}
        run: |
          mkdir -p existing-binaries
          # GoReleaser outputs to dist/<target>/cem[.exe]
          # Normalize to go-release-workflows naming: cem-<platform>[.exe]
          PLATFORM="${{ matrix.node_platform }}-${{ matrix.node_arch }}"
          if [[ "${{ matrix.goos }}" == "windows" ]]; then
            cp dist/*/cem.exe existing-binaries/cem-${PLATFORM}.exe
          else
            cp dist/*/cem existing-binaries/cem-${PLATFORM}
          fi

      - name: Upload existing binary
        uses: actions/upload-artifact@v4
        with:
          name: existing-${{ matrix.node_platform }}-${{ matrix.node_arch }}
          path: existing-binaries/
          retention-days: 1

  # ==========================================================================
  # NEW BUILD (go-release-workflows via Makefile targets)
  # ==========================================================================
  build-new:
    name: New Build
    uses: bennypowers/go-release-workflows/.github/workflows/build-binaries.yml@main
    with:
      binary-name: cem

  # ==========================================================================
  # VALIDATION
  # ==========================================================================
  validate:
    name: Validate (${{ matrix.platform }})
    needs: [build-existing, build-new]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        platform:
          - linux-x64
          - linux-arm64
          - darwin-x64
          - darwin-arm64
          - win32-x64
          - win32-arm64
      fail-fast: false
    steps:
      - uses: actions/checkout@v4

      - name: Download existing binary
        uses: actions/download-artifact@v4
        with:
          name: existing-${{ matrix.platform }}
          path: expected/

      - name: Download new binary
        uses: actions/download-artifact@v4
        with:
          name: cem-${{ matrix.platform }}
          path: actual/

      - name: List artifacts
        run: |
          echo "=== Expected (existing) ==="
          ls -la expected/
          file expected/* || true
          echo ""
          echo "=== Actual (new) ==="
          ls -la actual/
          file actual/* || true

      - name: Validate build outputs
        uses: bennypowers/go-release-workflows/.github/actions/validate-build@main
        with:
          expected-dir: expected
          actual-dir: actual

  # ==========================================================================
  # SUMMARY
  # ==========================================================================
  summary:
    name: Migration Summary
    needs: validate
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check validation results
        run: |
          if [[ "${{ needs.validate.result }}" == "success" ]]; then
            echo "## ✅ Build Migration Validation Passed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All binaries from the new build workflow match the existing build." >> $GITHUB_STEP_SUMMARY
            echo "You can safely switch to \`bennypowers/go-release-workflows\`." >> $GITHUB_STEP_SUMMARY
          else
            echo "## ❌ Build Migration Validation Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Some binaries differ between the existing and new build workflows." >> $GITHUB_STEP_SUMMARY
            echo "Review the validation job outputs for details." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Common reasons for differences:" >> $GITHUB_STEP_SUMMARY
            echo "- Build timestamps embedded in binary" >> $GITHUB_STEP_SUMMARY
            echo "- Different compiler versions" >> $GITHUB_STEP_SUMMARY
            echo "- Different linker flags" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
